use client\n\nimport { useEffect, useRef, useState, useCallback } from "react";\nimport PostCard from "./PostCard";\nimport { createClient } from "@/utils/supabase/client";\n\nconst POSTS_PER_PAGE = 20;\n\nexport default function Feed() {\n  const supabase = createClient();\n  const [posts, setPosts] = useState([]);\n  const [cursor, setCursor] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const sentinelRef = useRef<HTMLDivElement>(null);\n\n  // Load initial posts\n  const loadInitialPosts = useCallback(async () => {\n    setIsLoading(true);\n    try {\n      let query = supabase\n        .from("posts")\n        .select(`\n          id,\n          content,\n          media_url,\n          created_at,\n          author:profiles(id, name, avatar_url)\n        `)\n        .order("created_at", { ascending: false })\n        .limit(POSTS_PER_PAGE);\n\n      const { data, error } = await query;\n\n      if (error) throw error;\n\n      if (data?.length) {\n        setPosts(data);\n        setCursor(data[data.length - 1].created_at);\n        setHasMore(data.length === POSTS_PER_PAGE);\n      }\n    } catch (err) {\n      console.error("Error loading posts:", err);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [supabase]);\n\n  // Load more posts (cursor-based pagination)\n  const loadMore = useCallback(async () => {\n    if (isLoading || !hasMore || !cursor) return;\n\n    setIsLoading(true);\n    try {\n      let query = supabase\n        .from("posts")\n        .select(`\n          id,\n          content,\n          media_url,\n          created_at,\n          author:profiles(id, name, avatar_url)\n        `)\n        .order("created_at", { ascending: false })\n        .lt("created_at", cursor)\n        .limit(POSTS_PER_PAGE);\n\n      const { data, error } = await query;\n\n      if (error) throw error;\n\n      if (data?.length) {\n        setPosts((prev) => [...prev, ...data]);\n        setCursor(data[data.length - 1].created_at);\n        setHasMore(data.length === POSTS_PER_PAGE);\n      } else {\n        setHasMore(false);\n      }\n    } catch (err) {\n      console.error("Error loading more posts:", err);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [supabase, cursor, isLoading, hasMore]);\n\n  // IntersectionObserver for infinite scroll\n  useEffect(() => {\n    const observer = new IntersectionObserver(\n      (entries) => {\n        if (entries[0].isIntersecting && hasMore && !isLoading) {\n          loadMore();\n        }\n      },\n      { threshold: 0.1 }\n    );\n\n    if (sentinelRef.current) {\n      observer.observe(sentinelRef.current);\n    }\n\n    return () => observer.disconnect();\n  }, [loadMore, hasMore, isLoading]);\n\n  // Real-time updates via Supabase Realtime\n  useEffect(() => {\n    loadInitialPosts();\n\n    const channel = supabase\n      .channel("posts-feed")\n      .on(\n        "postgres_changes",\n        { event: "INSERT", schema: "public", table: "posts" },\n        (payload: any) => {\n          setPosts((prev) => [payload.new, ...prev]);\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [loadInitialPosts, supabase]);\n\n  return (\n    <div className="flex flex-col gap-4">\n      {posts.length === 0 && !isLoading && (\n        <p className="text-gray-400 text-center mt-10">\n          No posts yet. Be the first to share!\n        </p>\n      )}\n\n      {posts.map((post) => (\n        <PostCard key={post.id} {...post} />\n      ))}\n\n      {/* Sentinel element for infinite scroll trigger */}\n      <div ref={sentinelRef} className="h-4" />\n\n      {isLoading && (\n        <div className="flex justify-center py-8">\n          <div className="animate-spin rounded-full h-8 w-8 border border-[#00f2ff] border-t-transparent" />\n        </div>\n      )}\n\n      {!hasMore && posts.length > 0 && (\n        <p className="text-gray-500 text-center py-8">No more posts</p>\n      )}   \n    </div>\n  );\n}